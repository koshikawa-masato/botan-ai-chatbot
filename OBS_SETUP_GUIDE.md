# 牡丹 OBS Studio 設定ガイド

## 🎥 OBS Browser Sourceで字幕を表示する

このガイドでは、OBS Studioで牡丹の字幕をリアルタイム表示する方法を説明します。

---

## 📋 前提条件

### 必要なソフトウェア
- **OBS Studio 28.0以降** - [公式サイト](https://obsproject.com/)
- **牡丹システム** - Docker起動済み（`docker compose up -d`）

### 確認事項
```bash
# Dockerサービスが起動しているか確認
docker compose ps

# 以下の3つのサービスが"Up"であることを確認
# - 20251006-api-1 (Port 8000)
# - 20251006-core-1 (Port 8001)
# - 20251006-voice-1 (Port 8002)
```

---

## 🔧 OBS Studio設定手順

### Step 1: Browser Sourceの追加

1. **OBS Studioを起動**

2. **ソースパネルで「+」ボタンをクリック**

3. **「ブラウザ」を選択**
   - 「新規作成」を選択
   - 名前: `牡丹字幕` (任意)
   - 「OK」をクリック

### Step 2: URL設定

**プロパティウィンドウで以下を設定:**

- **URL**: `http://localhost:8000/static/obs/subtitle.html`
- **幅**: `1920`
- **高さ**: `1080`
- **FPS**: `30`（デフォルトのまま）
- **カスタムCSS**: 空欄（何も入力しない）

**チェックボックス設定:**
- ✅ **ページが表示されていないときにソースをシャットダウン**
- ✅ **シーンがアクティブになったときにブラウザの表示を更新**
- ❌ その他のオプション（無効のまま）

**「OK」をクリックして保存**

### Step 3: レイヤー配置

1. **ソースリストで「牡丹字幕」を最上位に移動**
   - ドラッグ＆ドロップで一番上に配置
   - これにより字幕が他の映像より前面に表示される

2. **配信プレビューで確認**
   - 透過背景が正しく適用されているか確認
   - 黒背景が表示される場合は、URLが正しいか再確認

---

## 🎨 レイアウト例

### 基本レイアウト（配信画面）
```
┌─────────────────────────────────────┐
│                                     │
│        ゲーム画面 or 作業画面         │
│                                     │
│                                     │
├─────────────────────────────────────┤
│  🌸 牡丹の字幕                       │  ← Browser Source (透過)
│  「オジサン、それマジでヤバいよ！」    │
└─────────────────────────────────────┘
```

### 推奨ソース順序（上から下）
1. **牡丹字幕**（Browser Source） - 最前面
2. Webカメラ（任意）
3. ゲーム画面 / デスクトップキャプチャ
4. 背景画像（任意）

---

## ✅ 動作確認

### 1. テストモードで確認

ブラウザで以下のURLを開く:
```
http://localhost:8000/static/obs/subtitle.html?test=1
```

**期待される動作:**
- 3秒後に「やっほー！オジサン！」と表示
- 5秒後に「今日も配信がんばろ〜」と表示
- 7秒後に「マジで楽しい！」と表示

### 2. WebUIでチャットして確認

1. ブラウザで `http://localhost:8000` を開く
2. メッセージを送信
3. 牡丹の応答が OBS Studio のプレビューに字幕表示されるか確認

**テストメッセージ例:**
- 「やっほー！」
- 「今日はいい天気だね」
- 「配信がんばろう」

### 3. OBS録画で確認

1. OBS Studioで「録画開始」
2. WebUIでメッセージを送信
3. 録画停止
4. 録画ファイルを再生して字幕が表示されているか確認

---

## 🎬 配信シナリオ

### 開発配信の流れ

**配信開始:**
1. OBS Studioで配信開始
2. 牡丹が自動的に挨拶（音声＋字幕）
3. 視聴者がコメント
4. 牡丹が応答（字幕表示）

**配信者（オジサン）:**
- 無言でコードを書く（OK）
- 牡丹が勝手に実況＋字幕

**視聴者視点:**
- 画面下部に牡丹の字幕が表示
- 音声が聞き取れなくても字幕で確認
- 配信の流れを理解しやすい

---

## 🔧 トラブルシューティング

### 問題1: 字幕が表示されない

**確認事項:**
1. Dockerサービスが起動しているか
   ```bash
   docker compose ps
   ```

2. URLが正しいか
   ```
   http://localhost:8000/static/obs/subtitle.html
   ```

3. OBS Browser Sourceのプロパティで「ページが表示されていないときにソースをシャットダウン」がONになっているか

4. ブラウザで直接URLを開いて動作するか確認
   ```
   http://localhost:8000/static/obs/subtitle.html?test=1
   ```

### 問題2: 透過背景が効いていない（黒背景が表示される）

**原因:**
- カスタムCSSに余計な記述がある
- URLが間違っている

**解決方法:**
1. Browser Sourceのプロパティを開く
2. カスタムCSSを完全に削除（空欄にする）
3. URLを再確認: `http://localhost:8000/static/obs/subtitle.html`
4. 「OK」で保存して再読み込み

### 問題3: WebSocket接続エラー

**症状:**
- 字幕が表示されない
- ブラウザのコンソールに「WebSocket connection failed」

**解決方法:**
1. Dockerサービス再起動
   ```bash
   docker compose restart api
   ```

2. APIサービスのログを確認
   ```bash
   docker compose logs api
   ```

3. ファイアウォール設定を確認（Port 8000が開いているか）

### 問題4: 字幕の表示時間が長すぎる/短すぎる

**調整方法:**
- `/static/obs/subtitle.js` の `SUBTITLE_DURATION` を変更
- デフォルト: 5000ms（5秒）
- 短くする場合: 3000ms（3秒）
- 長くする場合: 7000ms（7秒）

**変更後:**
```bash
docker compose restart api
```

---

## 🎨 カスタマイズ

### 字幕スタイルの変更

`/static/obs/subtitle.css` を編集して、字幕の見た目を変更できます。

**背景色を変更:**
```css
.subtitle-text {
    background: rgba(33, 150, 243, 0.75); /* 青系 */
}
```

**フォントサイズを変更:**
```css
.subtitle-text {
    font-size: 40px; /* デフォルト: 36px */
}
```

**位置を変更（上部に表示）:**
```css
.subtitle-container {
    top: 80px; /* 上部 */
    bottom: auto; /* 下部を解除 */
}
```

**変更を反映:**
```bash
docker compose restart api
```

---

## 📊 実際の配信例

### 例1: ゲーム実況配信

**ソース構成:**
1. 牡丹字幕（Browser Source）
2. ゲーム画面
3. Webカメラ（右下）

**配信の流れ:**
- 配信者: ゲームプレイ（無言OK）
- 牡丹: 実況コメント＋字幕
- 視聴者: コメント
- 牡丹: 応答＋字幕

### 例2: 開発配信

**ソース構成:**
1. 牡丹字幕（Browser Source）
2. デスクトップキャプチャ（VSCode等）

**配信の流れ:**
- 配信者: コーディング（無言OK）
- 牡丹: 開発実況＋字幕
- 視聴者: 質問コメント
- 牡丹: 回答＋字幕（配信者の代わり）

---

## 🚀 次のステップ

### Phase 2.1-B: スタイル拡張（実装予定）
- 複数字幕スタイル（ギャル風、技術解説風、スパチャ風）
- アニメーション効果追加
- カスタマイズ設定UI

### Phase 2.1-C: 高度な機能（実装予定）
- 字幕履歴表示（チャット風）
- エフェクト演出（リアクション）
- 視聴者コメント表示（棒読みちゃん風）

---

## 📝 よくある質問

### Q1: 配信にラグはありますか？

**A:** WebSocketによるリアルタイム配信のため、ラグはほぼありません（0.1秒以下）。

### Q2: 字幕は自動で消えますか？

**A:** はい、デフォルトで5秒後に自動的にフェードアウトします。

### Q3: 複数のシーンで同じ字幕を使えますか？

**A:** はい、各シーンに同じBrowser Sourceを追加するだけです。

### Q4: OBS Studio以外の配信ソフトでも使えますか？

**A:** Browser Source機能があれば使用可能です（XSplit等）。

### Q5: 配信していないときも字幕は動作しますか？

**A:** はい、ブラウザで直接開けばいつでもテスト可能です。

---

## 📞 サポート

**問題が解決しない場合:**
1. ログを確認
   ```bash
   docker compose logs api
   ```

2. WebSocket接続テスト
   ```bash
   python3 test_obs_websocket.py
   ```

3. システム再起動
   ```bash
   docker compose down
   docker compose up -d
   ```

---

**作成日**: 2025-10-06
**対応バージョン**: Phase 2.1-A
**対応OBS**: OBS Studio 28.0以降
