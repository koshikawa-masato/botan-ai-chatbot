# 牡丹 OBS連携システム設計書

## 📺 Phase 2.1: OBS Browser Source統合

### 目的
配信画面に牡丹の字幕・エフェクトをリアルタイム表示し、視聴者体験を向上させる。

---

## 🎯 実装目標

### 1. OBS Browser Source対応
- 透過背景のWebページを提供
- OBS Studio内で直接表示
- 配信画面にオーバーレイとして合成

### 2. 字幕表示システム
- WebSocket経由で牡丹の発言を受信
- アニメーション効果付き字幕表示
- 読みやすいフォント・配色

### 3. 配信レイアウト
- 字幕エリア（画面下部）
- エフェクトエリア（演出用）
- カスタマイズ可能なレイアウト

---

## 📐 システムアーキテクチャ

### OBS連携の仕組み
```
OBS Studio
  │
  ├─ Browser Source #1: 字幕表示
  │   └─ http://localhost:8000/obs/subtitle
  │       ├─ 透過背景
  │       ├─ WebSocket接続
  │       └─ リアルタイム字幕更新
  │
  ├─ Browser Source #2: エフェクト
  │   └─ http://localhost:8000/obs/effect
  │       ├─ アニメーション演出
  │       └─ 視覚効果
  │
  └─ ゲーム画面・カメラ等
```

### データフロー
```
牡丹応答生成（Core Service）
    ↓
API Gateway（WebSocket配信）
    ↓
OBS Browser Source（字幕表示）
    ↓
配信画面（視聴者が見る）
```

---

## 🛠️ 技術実装

### 1. 透過背景Webページ

**ファイル構成:**
```
/home/koshikawa/aite/20251006/static/
├─ obs/
│   ├─ subtitle.html    # 字幕表示専用
│   ├─ subtitle.js      # WebSocket + 字幕ロジック
│   └─ subtitle.css     # 透過背景 + スタイル
```

**CSS透過背景:**
```css
body {
    background: transparent !important;
    margin: 0;
    padding: 0;
    overflow: hidden;
}

.subtitle-container {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    text-align: center;
}

.subtitle-text {
    background: rgba(0, 0, 0, 0.7);
    color: #FFFFFF;
    font-size: 32px;
    font-weight: bold;
    padding: 20px 40px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
```

### 2. WebSocket字幕受信

**JavaScript実装:**
```javascript
// WebSocket接続
const ws = new WebSocket('ws://localhost:8000/ws/obs');

ws.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.type === 'subtitle') {
        showSubtitle(data.text, data.duration || 5000);
    }
};

function showSubtitle(text, duration) {
    const container = document.getElementById('subtitle-container');
    const subtitleDiv = document.createElement('div');
    subtitleDiv.className = 'subtitle-text';
    subtitleDiv.textContent = text;

    container.appendChild(subtitleDiv);

    // 指定時間後にフェードアウト
    setTimeout(() => {
        subtitleDiv.style.animation = 'fadeOut 0.5s ease-out';
        setTimeout(() => subtitleDiv.remove(), 500);
    }, duration);
}
```

### 3. WebSocketエンドポイント追加

**API Gateway拡張（api/main.py）:**
```python
@app.websocket("/ws/obs")
async def websocket_obs(websocket: WebSocket):
    """
    OBS専用WebSocketエンドポイント
    字幕データをブロードキャスト
    """
    await manager.connect(websocket)

    try:
        while True:
            # Core Serviceから応答を受信したら
            # 字幕データとして全OBSクライアントに配信
            await websocket.receive_text()
    except WebSocketDisconnect:
        manager.disconnect(websocket)
```

---

## 📋 OBS Studio設定手順

### 1. Browser Sourceの追加

**字幕表示設定:**
1. OBS Studio起動
2. ソース → 追加 → Browser
3. URL: `http://localhost:8000/obs/subtitle`
4. 幅: 1920
5. 高さ: 1080
6. ✅ ページが表示されていないときにソースをシャットダウン
7. ✅ シーンがアクティブになったときにブラウザの表示を更新

**透過設定:**
- 背景はCSSで`transparent`設定済み
- OBS側で特別な設定は不要

### 2. レイアウト配置

**推奨レイアウト:**
```
┌─────────────────────────────────┐
│                                 │
│      ゲーム画面・作業画面         │
│                                 │
│                                 │
├─────────────────────────────────┤
│  【牡丹の字幕】                  │  ← Browser Source (透過)
│  「オジサン、それヤバくない？」   │
└─────────────────────────────────┘
```

---

## 🎨 字幕スタイルバリエーション

### 1. 標準字幕（ベーシック）
- 黒背景（透過70%）
- 白文字・大きめフォント
- シンプル・読みやすい

### 2. ギャル風字幕（牡丹スタイル）
- ピンク〜紫グラデーション背景
- ポップなフォント
- キラキラエフェクト

### 3. 技術解説字幕（開発配信用）
- ダークブルー背景
- モノスペースフォント
- コードブロック風

### 4. スパチャ表示（将来実装）
- 金色背景
- アニメーション演出
- 読み上げ連動

---

## 🔄 配信フロー（実装後）

### 開発配信シナリオ
```
1. 配信者（オジサン）: コードを書く（無言OK）

2. 牡丹: 「オジサン、今何作ってるの？」
   → 字幕表示（OBS Browser Source）
   → 音声再生（ElevenLabs）

3. 視聴者: コメント「APIの実装してる？」

4. 牡丹: 「そう！APIって難しそうだよね〜」
   → 字幕表示（視聴者がリアルタイムで読める）

5. 配信者: 無言のまま実装続行
   → 牡丹が勝手に実況＋字幕
```

### 字幕の役割
- **視聴者の理解促進**: 牡丹の音声が聞き取れなくても字幕で確認
- **海外視聴者対応**: 将来的に多言語字幕
- **切り抜き素材**: 字幕付きで切り抜きやすい

---

## 📊 実装優先順位

### Phase 2.1-A: 基本字幕表示（最優先）
- [ ] 透過背景HTML/CSS作成
- [ ] WebSocket `/ws/obs` エンドポイント実装
- [ ] 字幕表示JavaScript実装
- [ ] OBS Browser Source設定ガイド作成

### Phase 2.1-B: スタイル拡張
- [ ] 複数字幕スタイル実装
- [ ] アニメーション効果追加
- [ ] カスタマイズ設定UI

### Phase 2.1-C: 高度な機能
- [ ] 字幕履歴表示（チャット風）
- [ ] エフェクト演出（リアクション）
- [ ] 視聴者コメント表示（棒読みちゃん風）

---

## 🧪 テスト計画

### 1. 透過背景テスト
```bash
# ブラウザで直接確認（背景が透明か）
http://localhost:8000/obs/subtitle
```

### 2. WebSocket接続テスト
```python
# test_obs_websocket.py
import asyncio
import websockets
import json

async def test_obs_subtitle():
    uri = "ws://localhost:8000/ws/obs"
    async with websockets.connect(uri) as websocket:
        # 字幕データ受信
        message = await websocket.recv()
        data = json.loads(message)
        print(f"Subtitle: {data['text']}")

asyncio.run(test_obs_subtitle())
```

### 3. OBS統合テスト
1. OBS StudioでBrowser Source追加
2. URLを`http://localhost:8000/obs/subtitle`に設定
3. 配信プレビューで字幕が表示されるか確認

---

## 💡 技術的考察

### WebSocket vs REST API
- **WebSocket選択理由**:
  - リアルタイム性が高い
  - サーバーからのプッシュ配信が可能
  - OBS Browser SourceのJavaScriptで動作

### 透過背景の重要性
- OBS Browser Sourceは`body { background: transparent }`で透過可能
- 配信画面に自然に合成できる
- レイヤー構造で柔軟なレイアウト

### パフォーマンス最適化
- 字幕DOMの削除タイミング管理
- WebSocket再接続ロジック
- メモリリーク防止

---

## 🚀 次のステップ

### 実装開始（Phase 2.1-A）
1. `/static/obs/subtitle.html` 作成
2. `/static/obs/subtitle.js` 作成
3. `/static/obs/subtitle.css` 作成
4. API Gateway `/ws/obs` エンドポイント追加
5. OBS設定ガイド作成

### 動作確認
1. Dockerサービス再起動
2. ブラウザで透過背景確認
3. WebSocket接続テスト
4. OBS統合テスト

### ドキュメント化
- OBS設定手順書
- 字幕カスタマイズガイド
- トラブルシューティング

---

**作成日**: 2025-10-06
**Phase**: 2.1 - OBS Browser Source統合
**ステータス**: 設計完了 → 実装準備中
